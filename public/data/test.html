<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Celestial Data with Interactive Functionality</title>

    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">

    <style>
        body {
            font-family: Arial, sans-serif;
            font-size: 16px;
            margin: 20px;
            background-color: #f4f4f9;
        }
        h1 {
            font-family: Arial, sans-serif;
            font-size: 32px;
            margin-top: 10px;
            margin-bottom: 5px;
        }
        #inputNote {
            font-family: Arial, sans-serif;
            font-size: 13px;
            color: #555;
        }
        .controls {
            margin-bottom: 20px;
            padding: 15px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .controls label, .controls button, .controls input {
             margin-right: 10px;
        }
        table {
            width: 100% !important;
            border-collapse: collapse;
        }
        th, td {
            text-align: center;
            vertical-align: middle;
        }
        .tabs {
            margin-top: 10px;
            margin-bottom: 15px;
        }
        .tab-button {
            display: inline-block;
            padding: 10px 20px;
            margin-right: 10px;
            cursor: pointer;
            border: 1px solid #ccc;
            background-color: #f9f9f9;
            border-radius: 5px;
            transition: all 0.3s ease;
        }
        .tab-button:hover {
            background-color: #e0e0e0;
        }
        .tab-button.active {
            background-color: #007bff;
            color: white;
            border-color: #007bff;
        }
        .text-end {
            text-align: right;
        }
    </style>
</head>
<body>

    <h1>Celestial Data - Orbital Elements</h1>

    <div class="controls">
        <label for="epochInput"><b>Specify a Date and Time:</b></label>
        <input type="datetime-local" id="epochInput">
        <button id="calculateButton">Calculate Orbital Elements</button>
        <br>
        <label id="inputNote">Note: All values are initialized with a J2000 fractional Julian Date (JD) epoch.</label>
    </div>


    <div class="tabs">
        <span class="tab-button active" data-filter="All">All</span>
        <span class="tab-button" data-filter="Planet">Planet</span>
        <span class="tab-button" data-filter="Comet">Comet</span>
        <span class="tab-button" data-filter="Asteroid">Asteroid</span>
        <span class="tab-button" data-filter="Misc">Miscellaneous</span>
    </div>

    <table id="satelliteTable" class="display">
        <thead>
            <tr>
                <th>ID</th>
                <th>Object Name</th>
                <th>Semi-major axis (km)</th>
                <th>Eccentricity</th>
                <th>Inclination (deg)</th>
                <th>Ascending Node (deg)</th>
                <th>Argument of Periapsis (deg)</th>
                <th>True anomaly (deg)</th>
                <th>JD (days)</th>
            </tr>
        </thead>
        <tbody>
            </tbody>
    </table>

    <script src="https://code.jquery.com/jquery-3.7.0.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

    <script>
        const tableData = [
            { objnum: "1", planetname: "Mercury", sma: "57909070.25241733", inclination: "7.005014362233553", eccentricity: "0.2056302515978038", longofascnode: "4.833053877672862", argofperi: "29.12427943500334", trueanomaly: "175.1155302923815", juliandate: '2451544.500000000', category: "Planet" },
            { objnum: "2", planetname: "Venus", sma: "108208156.5316098", inclination: "3.394589632757466", eccentricity: "0.006755697268576816", longofascnode: "76.67837511094160", argofperi: "55.18541504725159", trueanomaly: "49.90452231912491", juliandate: '2451544.500000000', category: "Planet" },
            { objnum: "3", planetname: "Earth", sma: "149653496.2738141", inclination: "0.0002668809336274974", eccentricity: "0.01704239718110438", longofascnode: "163.9748712430063", argofperi: "297.7671795415902", trueanomaly: "358.1260865474801", juliandate: '2451544.500000000', category: "Planet" },
            { objnum: "4", planetname: "Mars", sma: "227939012.0013493", inclination: "1.849876654038142", eccentricity: "0.09331460654155450", longofascnode: "49.56199905920329", argofperi: "286.5373583154345", trueanomaly: "23.02024685501411", juliandate: '2451544.500000000', category: "Planet" },
            { objnum: "5", planetname: "Jupiter", sma: "778673161.1090481", inclination: "1.304655711046047", eccentricity: "0.04892305962953223", longofascnode: "100.4888615724618", argofperi: "275.1197059498091", trueanomaly: "20.63463654069944", juliandate: '2451544.500000000', category: "Planet" },
            { objnum: "6", planetname: "Saturn", sma: "1433364815.997285", inclination: "2.484368779807340", eccentricity: "0.05559928887285597", longofascnode: "113.6930130794106", argofperi: "335.9006492558044", trueanomaly: "316.0917716241848", juliandate: '2451544.500000000', category: "Planet" },
            { objnum: "7", planetname: "Uranus", sma: "2876758957.338404", inclination: "0.7723604869115734", eccentricity: "0.04439336258840319", longofascnode: "73.96006633963485", argofperi: "96.61122696481169", trueanomaly: "145.8440420932308", juliandate: '2451544.500000000', category: "Planet" },
            { objnum: "8", planetname: "Neptune", sma: "4502447638.507132", inclination: "1.773472322935706", eccentricity: "0.01114797945577682", longofascnode: "131.7693429431158", argofperi: "266.8221317471495", trueanomaly: "265.3306958227381", juliandate: '2451544.500000000', category: "Planet" },
            { objnum: "9", planetname: "Pluto", sma: "5909204116.434813", inclination: "17.16588400262404", eccentricity: "0.2478572758892915", longofascnode: "110.2442370814283", argofperi: "115.1513716103666", trueanomaly: "23.85922557604604", juliandate: '2451544.500000000', category: "Planet" },
            { objnum: "10", planetname: "Halley's Comet", sma: "1.143E+08", inclination: "", eccentricity: "0.967", longofascnode: "", argofperi: "", trueanomaly: "", juliandate: '1235', category: "Comet" },
            { objnum: "20", planetname: "Ceres", sma: "4.14E+08", inclination: "", eccentricity: "0.08", longofascnode: "", argofperi: "", trueanomaly: "", juliandate: '1235', category: "Asteroid" },
            { objnum: "30", planetname: "Misc Object", sma: "1.23E+08", inclination: "", eccentricity: "0.1", longofascnode: "", argofperi: "", trueanomaly: "", juliandate: '1235', category: "Misc" }
        ];

        $(document).ready(function () {
            // 1. Initialize DataTables
            const table = $('#satelliteTable').DataTable({
                data: tableData, // Use the hardcoded data
                columns: [
                    { data: "objnum" },
                    { data: "planetname" },
                    { data: "sma", render: function (data, type, row) { if(!data) return ''; return parseFloat(data.replace(/,/g, "")).toLocaleString("en-US", { maximumFractionDigits: 0 }); }, className: "text-end" },
                    { data: "eccentricity", render: function (data, type, row) { if(!data) return ''; return parseFloat(data).toFixed(5); }, className: "text-end" },
                    { data: "inclination", render: function (data, type, row) { if(!data) return ''; return parseFloat(data).toFixed(5); }, className: "text-end" },
                    { data: "longofascnode", render: function (data, type, row) { if(!data) return ''; return parseFloat(data).toFixed(5); }, className: "text-end" },
                    { data: "argofperi", render: function (data, type, row) { if(!data) return ''; return parseFloat(data).toFixed(5); }, className: "text-end" },
                    { data: "trueanomaly", render: function (data, type, row) { if(!data) return ''; return parseFloat(data).toFixed(5); }, className: "text-end" },
                    { data: "juliandate", render: function (data, type, row) { if(!data) return ''; return parseFloat(data).toFixed(5); }, className: "text-end" },
                ],
                autoWidth: false,
                paging: true,
                searching: true,
                ordering: true,
                responsive: true,
            });

            // 2. Add custom search function for category filtering
            $.fn.dataTable.ext.search.push(function (settings, data, dataIndex) {
                const selectedCategory = $('.tab-button.active').data('filter');
                const rowCategory = table.row(dataIndex).data().category;
                if (selectedCategory === "All" || rowCategory === selectedCategory) {
                    return true;
                }
                return false;
            });

            // 3. Tab functionality
            $('.tab-button').on('click', function () {
                $('.tab-button').removeClass('active');
                $(this).addClass('active');
                table.draw(); // Redraw the table with the new filter
            });

            // 4. Orbital Propagation Section
            const GRAVITATIONAL_PARAMETER = 1.32712440018e11; // km^3/s^2 for the Sun

            function calculateNewTrueAnomaly(row, newJulianDate) {
                // Return NaN if data is missing
                if (!row.sma || !row.eccentricity || !row.juliandate) {
                    return NaN;
                }
                const sma = parseFloat(row.sma.replace(/,/g, ""));
                const eccentricity = parseFloat(row.eccentricity);
                const originalJulianDate = parseFloat(row.juliandate);

                const meanMotion = Math.sqrt(GRAVITATIONAL_PARAMETER / Math.pow(sma, 3)) * 86400; // rad/day
                const deltaTime = newJulianDate - originalJulianDate; // days
                const M = (meanMotion * deltaTime) % (2 * Math.PI); // Mean Anomaly

                // Solve Kepler's Equation for Eccentric Anomaly (E)
                let E = M;
                for (let i = 0; i < 100; i++) {
                    const deltaE = (M - (E - eccentricity * Math.sin(E))) / (1 - eccentricity * Math.cos(E));
                    E += deltaE;
                    if (Math.abs(deltaE) < 1e-6) break;
                }

                // Calculate True Anomaly (ν)
                const trueAnomaly = 2 * Math.atan2(
                    Math.sqrt(1 + eccentricity) * Math.sin(E / 2),
                    Math.sqrt(1 - eccentricity) * Math.cos(E / 2)
                );

                return (trueAnomaly * 180 / Math.PI); // Convert rad to deg
            }

            function gregorianToJulian(dateString) {
                const date = new Date(dateString);
                const Y = date.getUTCFullYear();
                const M = date.getUTCMonth() + 1;
                const D = date.getUTCDate();
                const H = date.getUTCHours();
                const Min = date.getUTCMinutes();
                const S = date.getUTCSeconds();

                const A = Math.floor(Y / 100);
                const B = 2 - A + Math.floor(A / 4);
                const JD = Math.floor(365.25 * (Y + 4716)) + Math.floor(30.6001 * (M + 1)) + D + B - 1524.5 +
                           (H + Min / 60 + S / 3600) / 24;
                return JD;
            }

            // 5. Event listener for "Calculate" button
            $('#calculateButton').on('click', function () {
                const inputDate = $('#epochInput').val();
                if (!inputDate) {
                    alert("Please specify a valid date and time.");
                    return;
                }

                const newJulianDate = gregorianToJulian(inputDate);

                // Update the data for each row in the original array
                tableData.forEach(row => {
                    const newTrueAnomaly = calculateNewTrueAnomaly(row, newJulianDate);
                    if (!isNaN(newTrueAnomaly)) {
                         row.trueanomaly = newTrueAnomaly.toString();
                         row.juliandate = newJulianDate.toString();
                    }
                });

                // Redraw the table with updated data
                table.clear().rows.add(tableData).draw();
            });
        });
    </script>
</body>
</html>